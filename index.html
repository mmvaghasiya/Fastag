<!DOCTYPE html>
<html>
<head>
  <title>Buy FASTag</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <style>
    body { font-family: Arial; max-width: 600px; margin: auto; padding: 20px; }
    label { display: block; margin-top: 15px; }
    .warning { color: red; font-size: 13px; margin-top: 5px; }
    .success { color: green; }
  </style>
</head>
<body>
  <h2>Buy FASTag â€“ â‚¹600</h2>

  <form id="fastagForm">
    <label>Name</label>
    <input type="text" id="fullName" required>

    <label>Mobile Number</label>
    <input type="tel" id="mobile" required>

    <label>Upload PAN Card</label>
    <input type="file" id="panUpload" accept="image/*" required>
    <div id="panData"></div>

    <label>Upload Aadhar or Driving License</label>
    <input type="file" id="idUpload" accept="image/*" required>
    <div id="idData"></div>

    <div class="warning" id="mismatchWarning"></div>

    <button type="submit">Submit Order</button>
    <div id="statusMsg"></div>
  </form>
<script>
  // ðŸ”§ Firebase Config (replace with your actual config if needed)
  const firebaseConfig = {
    apiKey: "YOUR_FIREBASE_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const panUpload = document.getElementById('panUpload');
  const idUpload = document.getElementById('idUpload');
  const panData = document.getElementById('panData');
  const idData = document.getElementById('idData');
  const mismatchWarning = document.getElementById('mismatchWarning');
  const statusMsg = document.getElementById('statusMsg');

  let panInfo = { name: "", dob: "" };
  let idInfo = { name: "", dob: "" };

  async function extractText(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('apikey', 'helloworld'); // public demo key
    formData.append('OCREngine', 2);
    const res = await fetch('https://api.ocr.space/parse/image', {
      method: 'POST',
      body: formData
    });
    const json = await res.json();
    return json.ParsedResults?.[0]?.ParsedText || '';
  }

  function showWarningIfMismatch() {
    if (panInfo.name && idInfo.name && (panInfo.name !== idInfo.name || panInfo.dob !== idInfo.dob)) {
      mismatchWarning.textContent = 'âš ï¸ PAN and ID document Name or DOB do not match. Please re-check.';
    } else {
      mismatchWarning.textContent = '';
    }
  }

  panUpload.addEventListener('change', async (e) => {
    const text = await extractText(e.target.files[0]);
    panInfo.name = (text.match(/Name[:\-]?\s*(.*)/i) || [])[1] || '';
    panInfo.dob = (text.match(/DOB[:\-]?\s*(.*)/i) || [])[1] || '';
    panData.innerHTML = `<strong>PAN:</strong> ${panInfo.name || 'Name not found'}, ${panInfo.dob || 'DOB not found'}`;
    showWarningIfMismatch();
  });

  idUpload.addEventListener('change', async (e) => {
    const text = await extractText(e.target.files[0]);
    idInfo.name = (text.match(/Name[:\-]?\s*(.*)/i) || [])[1] || '';
    idInfo.dob = (text.match(/DOB[:\-]?\s*(.*)/i) || [])[1] || '';
    idData.innerHTML = `<strong>ID:</strong> ${idInfo.name || 'Name not found'}, ${idInfo.dob || 'DOB not found'}`;
    showWarningIfMismatch();
  });

  document.getElementById('fastagForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('fullName').value;
    const mobile = document.getElementById('mobile').value;

    if (!panUpload.files[0] || !idUpload.files[0]) {
      alert("Please upload both PAN Card and Aadhar/License.");
      return;
    }

    const newRef = db.ref("orders").push();
    await newRef.set({
      name, mobile,
      panName: panInfo.name,
      panDOB: panInfo.dob,
      idName: idInfo.name,
      idDOB: idInfo.dob
    });

    statusMsg.innerHTML = '<div class="success">âœ… Order submitted successfully!</div>';
    e.target.reset();
    panData.innerHTML = '';
    idData.innerHTML = '';
    mismatchWarning.textContent = '';
  });
</script>
